<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC LIAM - Earn & Learn</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .rotate-y-0 { transform: rotateY(0deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 0.75rem;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        .animate-popIn { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        @keyframes coinUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        .coin-float { animation: coinUp 0.8s ease-out forwards; pointer-events: none; }

        .topic-chip.selected {
            background-color: #4F46E5; /* Indigo 600 */
            color: white;
            border-color: #4338ca;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CẤU HÌNH FIREBASE ---
        const firebaseConfigManual = {
            apiKey: "AIzaSyCM_gVrI8Yfg-eghdzMT5aIKx_vh9eNavc",
            authDomain: "toeic-game.firebaseapp.com",
            projectId: "toeic-game",
            storageBucket: "toeic-game.firebasestorage.app",
            messagingSenderId: "256652471234",
            appId: "1:256652471234:web:227e24e34cd391a1fec45b",
            measurementId: "G-4TTN534GNR"
        };

        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { firebaseConfig = firebaseConfigManual; }
        } else { firebaseConfig = firebaseConfigManual; }
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        
        const app = firebase.apps.length ? firebase.app() : null;
        const auth = app ? firebase.auth() : null;
        const db = app ? firebase.firestore() : null;
        const googleProvider = auth ? new firebase.auth.GoogleAuthProvider() : null;
        
        const appId = 'toeic-master-live-v1';

        // --- DATA ---
        const rawDataString = `
Contracts|Abide by|/əˈbaɪd baɪ/|Tuân thủ, tuân theo đầy đủ các quy định đã cam kết|All parties must abide by the terms.|Follow, Comply with|Violate
Contracts|Agreement|/əˈɡriːmənt/|Hợp đồng, thỏa thuận chính thức giữa các bên|Reach a mutual agreement.|Contract, Accord|Disagreement
Contracts|Assurance|/əˈʃʊrəns/|Sự đảm bảo, cam đoan về việc thực hiện nghĩa vụ|Give written assurance of quality.|Guarantee, Pledge|Doubt
Contracts|Binding|/ˈbaɪndɪŋ/|Có tính ràng buộc pháp lý, bắt buộc phải tuân theo|The contract is legally binding.|Obligatory, Compulsory|Non-binding
Contracts|Breach|/briːtʃ/|Vi phạm hợp đồng, không thực hiện đúng cam kết|Breach of contract results in penalties.|Violation, Infringement|Compliance
Contracts|Cancellation|/ˌkænsəˈleɪʃn/|Sự hủy bỏ hợp đồng trước thời hạn đáo hạn|Contract cancellation requires notice.|Termination, Annulment|Confirmation
Contracts|Clause|/klɔːz/|Điều khoản, mục cụ thể trong hợp đồng|Read the termination clause carefully.|Provision, Article|N/A
Contracts|Comply with|/kəmˈplaɪ wɪð/|Tuân thủ, làm theo yêu cầu hoặc quy định|Comply with regulatory requirements.|Adhere to, Follow|Violate
Contracts|Confidentiality|/ˌkɒnfɪdenʃiˈæləti/|Tính bảo mật, nghĩa vụ giữ bí mật thông tin|Sign a confidentiality agreement.|Secrecy, Privacy|Disclosure
Contracts|Contingency|/kənˈtɪndʒənsi/|Điều khoản dự phòng cho tình huống bất ngờ|Include a contingency clause.|Backup plan, Provision|N/A
Contracts|Counterpart|/ˈkaʊntərpɑːrt/|Bản sao hợp đồng, bên tương ứng trong thỏa thuận|Each party receives a signed counterpart.|Copy, Duplicate|N/A
Contracts|Covenant|/ˈkʌvənənt/|Cam kết chính thức, điều ràng buộc trong hợp đồng|Non-compete covenant protects business interests.|Agreement, Promise|N/A
Contracts|Default|/dɪˈfɔːlt/|Không thực hiện nghĩa vụ, vi phạm điều khoản thanh toán|Default on loan payments.|Failure, Non-payment|Fulfillment
Contracts|Determine|/dɪˈtɜːrmɪn/|Xác định, quyết định các điều kiện cụ thể|Determine payment terms in advance.|Decide, Establish|Hesitate
Contracts|Dispute|/dɪˈspjuːt/|Tranh chấp, bất đồng về điều khoản hợp đồng|Resolve disputes through mediation.|Disagreement, Conflict|Agreement
Contracts|Due diligence|/djuː ˈdɪlɪdʒəns/|Thẩm định, xem xét kỹ lưỡng trước khi ký kết|Conduct due diligence before signing.|Investigation, Review|N/A
Contracts|Effectuate|/ɪˈfektʃueɪt/|Thực thi, đưa hợp đồng vào hiệu lực|Effectuate the agreement immediately.|Execute, Implement|Cancel
Contracts|Enforce|/ɪnˈfɔːrs/|Thi hành, buộc thực hiện theo hợp đồng|Enforce contractual obligations.|Implement, Execute|Waive
Contracts|Engage|/ɪnˈɡeɪdʒ/|Cam kết, thuê dịch vụ hoặc tham gia thỏa thuận|Engage legal counsel for negotiations.|Hire, Commit|Withdraw
Contracts|Establish|/ɪˈstæblɪʃ/|Thiết lập, tạo ra các điều khoản chính thức|Establish clear deliverables.|Set up, Create|Destroy
Contracts|Execute|/ˈeksɪkjuːt/|Ký kết chính thức, thực hiện hợp đồng|Execute the contract in duplicate.|Sign, Implement|Cancel
Contracts|Expiration|/ˌekspəˈreɪʃn/|Hết hạn, ngày kết thúc hiệu lực hợp đồng|Contract expiration date is June 30.|Termination, End|Commencement
Contracts|Force majeure|/fɔːrs mæˈʒɜːr/|Sự kiện bất khả kháng (thiên tai, chiến tranh)|Force majeure clause protects from liability.|Act of God, Unforeseen event|N/A
Contracts|Indemnify|/ɪnˈdemnɪfaɪ/|Bồi thường, đảm bảo không bị thiệt hại|The seller agrees to indemnify the buyer.|Compensate, Reimburse|N/A
Contracts|Liability|/ˌlaɪəˈbɪləti/|Trách nhiệm pháp lý, nghĩa vụ phải chịu|Limit liability in the contract.|Responsibility, Obligation|Immunity
Contracts|Negotiate|/nɪˈɡəʊʃieɪt/|Thương lượng, đàm phán các điều khoản|Negotiate favorable terms.|Bargain, Discuss|Accept
Contracts|Obligate|/ˈɒblɪɡeɪt/|Bắt buộc, ràng buộc về mặt pháp lý|The contract obligates payment within 30 days.|Compel, Bind|Free
Contracts|Party|/ˈpɑːrti/|Bên tham gia hợp đồng, đối tượng ký kết|Third-party involvement requires approval.|Participant, Signatory|N/A
Contracts|Provision|/prəˈvɪʒn/|Điều khoản, quy định cụ thể trong văn bản|Review all provisions thoroughly.|Clause, Stipulation|N/A
Contracts|Ratify|/ˈrætɪfaɪ/|Phê chuẩn, chính thức công nhận hợp đồng|The board will ratify the agreement.|Approve, Confirm|Reject
Contracts|Remedy|/ˈremədi/|Biện pháp khắc phục khi vi phạm hợp đồng|Legal remedies include compensation.|Solution, Recourse|N/A
Contracts|Renewal|/rɪˈnjuːəl/|Gia hạn, kéo dài thời hạn hợp đồng|Contract renewal requires mutual consent.|Extension, Continuation|Termination
Contracts|Rescind|/rɪˈsɪnd/|Hủy bỏ, thu hồi hợp đồng đã ký|Rescind the agreement due to fraud.|Cancel, Revoke|Uphold
Contracts|Resolve|/rɪˈzɒlv/|Giải quyết vấn đề hoặc tranh chấp hợp đồng|Resolve disputes through arbitration.|Settle, Fix|Complicate
Contracts|Severability|/ˌsevərəˈbɪləti/|Tính khả thi riêng của từng điều khoản|Severability clause preserves remaining terms.|Separability|N/A
Contracts|Specific|/spəˈsɪfɪk/|Cụ thể, rõ ràng, không mơ hồ|Specify exact delivery dates.|Precise, Explicit|Vague
Contracts|Stipulate|/ˈstɪpjuleɪt/|Quy định rõ ràng trong hợp đồng|Stipulate payment conditions.|Specify, State|Omit
Contracts|Subcontract|/ˈsʌbkɒntrækt/|Hợp đồng phụ, thuê lại cho bên thứ ba|Subcontract specialized work.|Outsource, Delegate|N/A
Contracts|Termination|/ˌtɜːrmɪˈneɪʃn/|Chấm dứt hợp đồng trước hoặc đúng hạn|Early termination incurs fees.|Ending, Cancellation|Continuation
Contracts|Waive|/weɪv/|Từ bỏ quyền lợi, không đòi hỏi thực hiện|Waive the right to sue.|Relinquish, Forgo|Claim
Contracts|Warranty|/ˈwɒrənti/|Bảo đảm, cam kết về chất lượng sản phẩm|Warranty covers manufacturing defects.|Guarantee, Assurance|N/A
Contracts|Whereas|/weərˈæz/|Trong khi đó, điều khoản mở đầu hợp đồng|Whereas the parties agree to collaborate...|Given that, Considering|N/A
Contracts|Witness|/ˈwɪtnəs/|Người làm chứng khi ký hợp đồng|Two witnesses signed the document.|Observe, Attest|N/A
Marketing|Advertise|/ˈædvərtaɪz/|Quảng cáo, đăng thông tin sản phẩm trên các phương tiện truyền thông|Advertise on social media platforms.|Promote, Publicize|Conceal
Marketing|Appeal|/əˈpiːl/|Sức hấp dẫn, khả năng lôi cuốn khách hàng mục tiêu|The product has broad consumer appeal.|Attraction, Allure|Repulsion
Marketing|Attract|/əˈtrækt/|Thu hút sự chú ý của khách hàng tiềm năng|Attract customers with compelling offers.|Draw, Lure|Repel
Marketing|Awareness|/əˈweənəs/|Nhận thức, mức độ biết đến thương hiệu|Build brand awareness through campaigns.|Recognition, Consciousness|Ignorance
Marketing|Branding|/ˈbrændɪŋ/|Xây dựng thương hiệu, tạo hình ảnh riêng biệt|Effective branding creates customer loyalty.|Brand identity, Positioning|N/A
Marketing|Campaign|/kæmˈpeɪn/|Chiến dịch quảng cáo có kế hoạch và mục tiêu rõ ràng|Launch a marketing campaign this quarter.|Initiative, Drive|N/A
Marketing|Clientele|/ˌklaɪənˈtel/|Tập khách hàng, nhóm người mua hàng thường xuyên|Expand our clientele through referrals.|Customer base, Patrons|N/A
Marketing|Compare|/kəmˈpeər/|So sánh sản phẩm với đối thủ cạnh tranh|Compare features and benefits.|Contrast, Evaluate|Ignore
Marketing|Competition|/ˌkɒmpəˈtɪʃn/|Sự cạnh tranh gay gắt trên thị trường|Face intense competition in the sector.|Rivalry, Contest|Cooperation
Marketing|Competitive advantage|/kəmˈpetɪtɪv ədˈvæntɪdʒ/|Lợi thế cạnh tranh, điểm mạnh vượt trội so với đối thủ|Innovation provides competitive advantage.|Edge, Superiority|Disadvantage
Marketing|Consumer behavior|/kənˈsjuːmər bɪˈheɪvjər/|Hành vi người tiêu dùng, cách khách hàng ra quyết định mua|Study consumer behavior patterns.|Buying habits, Purchasing patterns|N/A
Marketing|Consume|/kənˈsjuːm/|Tiêu thụ, sử dụng sản phẩm hoặc dịch vụ|Consumers consume more during holidays.|Use, Utilize|Produce
Marketing|Conversion rate|/kənˈvɜːrʒn reɪt/|Tỷ lệ chuyển đổi từ khách hàng tiềm năng thành mua hàng|Improve conversion rates through testing.|Sales rate, Purchase ratio|N/A
Marketing|Convince|/kənˈvɪns/|Thuyết phục khách hàng tin tưởng và mua sản phẩm|Convince buyers with testimonials.|Persuade, Influence|Discourage
Marketing|Currently|/ˈkʌrəntli/|Hiện tại, trong giai đoạn này của thị trường|Currently offering a limited-time discount.|Presently, Now|Previously
Marketing|Customer retention|/ˈkʌstəmər rɪˈtenʃn/|Giữ chân khách hàng, duy trì lòng trung thành|Focus on customer retention strategies.|Loyalty maintenance|Customer loss
Marketing|Demographic|/ˌdeməˈɡræfɪk/|Nhân khẩu học, phân khúc khách hàng theo tuổi, giới tính|Target specific demographic groups.|Population segment, Market segment|N/A
Marketing|Differentiate|/ˌdɪfəˈrenʃieɪt/|Tạo sự khác biệt, phân biệt sản phẩm với đối thủ|Differentiate through unique features.|Distinguish, Set apart|Homogenize
Marketing|Distribution channel|/ˌdɪstrɪˈbjuːʃn ˈtʃænl/|Kênh phân phối, đường đi của sản phẩm đến tay người tiêu dùng|Expand distribution channels online.|Sales channel, Supply route|N/A
Marketing|Endorsement|/ɪnˈdɔːrsmənt/|Sự ủng hộ, quảng cáo bởi người nổi tiếng|Celebrity endorsements boost sales.|Support, Approval|Criticism
Marketing|Engagement|/ɪnˈɡeɪdʒmənt/|Mức độ tương tác của khách hàng với thương hiệu|Social media engagement is increasing.|Interaction, Involvement|Disengagement
Marketing|Fad|/fæd/|Mốt nhất thời, xu hướng ngắn hạn trên thị trường|Don't invest heavily in passing fads.|Trend, Craze|Classic
Marketing|Focus group|/ˈfəʊkəs ɡruːp/|Nhóm khách hàng thử nghiệm để thu thập ý kiến|Conduct focus groups before launch.|Test panel, Sample group|N/A
Marketing|Impression|/ɪmˈpreʃn/|Lượt hiển thị quảng cáo, số lần được nhìn thấy|Track ad impressions and click-through rates.|View, Exposure|N/A
Marketing|Incentive|/ɪnˈsentɪv/|Ưu đãi khuyến khích khách hàng mua hàng|Offer incentives for early purchases.|Motivation, Reward|Disincentive
Marketing|Influencer|/ˈɪnfluənsər/|Người có ảnh hưởng trên mạng xã hội|Partner with influencers for promotion.|Opinion leader, Trendsetter|N/A
Marketing|Innovation|/ˌɪnəˈveɪʃn/|Đổi mới sản phẩm hoặc phương thức tiếp thị|Innovation drives market leadership.|Novelty, Breakthrough|Stagnation
Marketing|Inspiration|/ˌɪnspəˈreɪʃn/|Cảm hứng cho chiến dịch sáng tạo|Draw inspiration from customer stories.|Creativity, Motivation|N/A
Marketing|Launch|/lɔːntʃ/|Ra mắt sản phẩm mới ra thị trường|Launch the new product line next month.|Release, Introduce|Discontinue
Marketing|Lead generation|/liːd ˌdʒenəˈreɪʃn/|Tạo khách hàng tiềm năng, thu thập thông tin người quan tâm|Focus on lead generation strategies.|Prospect finding, Customer acquisition|N/A
Marketing|Loyalty program|/ˈlɔɪəlti ˈprəʊɡræm/|Chương trình khách hàng thân thiết, tích điểm đổi quà|Launch a loyalty program for repeat customers.|Rewards scheme, Points system|N/A
Marketing|Market research|/ˈmɑːrkɪt rɪˈsɜːrtʃ/|Nghiên cứu thị trường, phân tích nhu cầu khách hàng|Conduct market research before expansion.|Consumer analysis, Market study|N/A
Marketing|Market segment|/ˈmɑːrkɪt ˈseɡmənt/|Phân khúc thị trường, nhóm khách hàng mục tiêu cụ thể|Target the premium market segment.|Customer group, Niche|N/A
Marketing|Market share|/ˈmɑːrkɪt ʃeər/|Thị phần, tỷ lệ chiếm lĩnh thị trường|Increase market share by 15%.|Market portion, Market penetration|N/A
Marketing|Niche|/niːʃ/|Thị trường ngách, phân khúc hẹp và chuyên biệt|Target a profitable niche market.|Specialty market, Segment|Mass market
Marketing|Outreach|/ˈaʊtriːtʃ/|Tiếp cận khách hàng, mở rộng kết nối với công chúng|Community outreach builds brand trust.|Contact, Engagement|Withdrawal
Marketing|Penetration|/ˌpenɪˈtreɪʃn/|Thâm nhập thị trường, mở rộng khách hàng|Market penetration strategies are essential.|Entry, Infiltration|Withdrawal
Marketing|Perception|/pərˈsepʃn/|Nhận thức của khách hàng về thương hiệu|Shape positive brand perception.|Impression, View|Reality
Marketing|Persuasion|/pərˈsweɪʒn/|Sự thuyết phục, kỹ thuật lôi kéo khách hàng|Master persuasion techniques in sales.|Influence, Convincing|Coercion
Marketing|Positioning|/pəˈzɪʃnɪŋ/|Định vị thương hiệu trong tâm trí khách hàng|Strategic positioning differentiates the brand.|Placement, Market position|N/A
Marketing|Productive|/prəˈdʌktɪv/|Hiệu quả cao, tạo ra kết quả tốt|Productive marketing campaigns yield results.|Effective, Efficient|Unproductive
Marketing|Promotion|/prəˈməʊʃn/|Khuyến mãi, hoạt động xúc tiến bán hàng|Run a promotion for new customers.|Sale, Special offer|N/A
Marketing|Reach|/riːtʃ/|Phạm vi tiếp cận, số người nhìn thấy quảng cáo|Expand reach through digital channels.|Audience, Coverage|N/A
Marketing|Retention|/rɪˈtenʃn/|Giữ chân khách hàng, duy trì lâu dài|Customer retention reduces acquisition costs.|Loyalty, Maintenance|Loss
Marketing|ROI (Return on Investment)|/ɑːr əʊ aɪ/|Lợi tức đầu tư, hiệu quả tài chính của chiến dịch|Measure marketing ROI carefully.|Profitability, Return|Loss
Marketing|Satisfaction|/ˌsætɪsˈfækʃn/|Sự hài lòng của khách hàng về sản phẩm|Ensure customer satisfaction through quality.|Contentment, Fulfillment|Dissatisfaction
Marketing|Slogan|/ˈsləʊɡən/|Khẩu hiệu, câu quảng cáo ngắn gọn dễ nhớ|Create a memorable brand slogan.|Tagline, Catchphrase|N/A
Marketing|Target audience|/ˈtɑːrɡɪt ˈɔːdiəns/|Đối tượng mục tiêu, nhóm khách hàng cần hướng đến|Define the target audience clearly.|Intended market, Demographics|N/A
Marketing|Testimonial|/ˌtestɪˈməʊniəl/|Lời chứng thực, đánh giá tích cực từ khách hàng|Feature customer testimonials on the website.|Recommendation, Endorsement|Criticism
Marketing|Trend|/trend/|Xu hướng, hướng phát triển của thị trường|Follow emerging market trends.|Tendency, Direction|Constancy
Marketing|Value proposition|/ˈvæljuː ˌprɒpəˈzɪʃn/|Giá trị đề xuất, lợi ích độc đáo cho khách hàng|Communicate a clear value proposition.|Unique benefit, Selling point|N/A
Marketing|Viral marketing|/ˈvaɪrəl ˈmɑːrkɪtɪŋ/|Tiếp thị lan truyền qua mạng xã hội|Content went viral on social media.|Buzz marketing, Word-of-mouth|N/A
Marketing|Word-of-mouth|/wɜːrd əv maʊθ/|Truyền miệng, khách hàng giới thiệu cho nhau|Rely on word-of-mouth recommendations.|Personal recommendation, Referral|N/A
Warranties|Characteristic|/ˌkærəktəˈrɪstɪk/|Đặc tính, đặc điểm riêng biệt của sản phẩm|Key characteristics include durability.|Feature, Trait|N/A
Warranties|Claim|/kleɪm/|Yêu cầu bồi thường, khiếu nại theo bảo hành|File a warranty claim within 30 days.|Request, Demand|Waive
Warranties|Consequence|/ˈkɒnsɪkwəns/|Hậu quả khi vi phạm điều khoản bảo hành|Failure to comply has serious consequences.|Result, Outcome|Cause
Warranties|Consider|/kənˈsɪdər/|Cân nhắc, xem xét kỹ trước khi quyết định|Consider all warranty options carefully.|Think about, Evaluate|Ignore
Warranties|Coverage|/ˈkʌvərɪdʒ/|Phạm vi bảo hành, những gì được bao gồm|Full coverage includes parts and labor.|Protection, Inclusion|Exclusion
Warranties|Defect|/ˈdiːfekt/|Khuyết tật, lỗi sản xuất trong sản phẩm|Report defects within the warranty period.|Flaw, Imperfection|Perfection
Warranties|Exclusion|/ɪkˈskluːʒn/|Loại trừ, những gì không được bảo hành|Read warranty exclusions carefully.|Exception, Omission|Inclusion
Warranties|Expiration|/ˌekspəˈreɪʃn/|Hết hạn bảo hành, ngày kết thúc hiệu lực|Check the warranty expiration date.|Termination, End date|Commencement
Warranties|Extended warranty|/ɪkˈstendɪd ˈwɒrənti/|Bảo hành kéo dài, gói bảo hành mở rộng thêm|Purchase an extended warranty for peace of mind.|Additional coverage, Service plan|N/A
Warranties|Frequently|/ˈfriːkwəntli/|Thường xuyên, xảy ra nhiều lần|Frequently asked questions about warranties.|Often, Regularly|Rarely
Warranties|Guarantee|/ˌɡærənˈtiː/|Đảm bảo, cam kết chất lượng sản phẩm|We guarantee satisfaction or money back.|Assurance, Promise|Risk
Warranties|Imply|/ɪmˈplaɪ/|Ngụ ý, ám chỉ không nói rõ ràng|The warranty implies certain obligations.|Suggest, Indicate|State explicitly
Warranties|Limitation|/ˌlɪmɪˈteɪʃn/|Giới hạn, hạn chế của phạm vi bảo hành|Understand warranty limitations before purchase.|Restriction, Constraint|Extension
Warranties|Malfunction|/mælˈfʌŋkʃn/|Sự trục trặc, hoạt động không đúng cách|Report malfunctions immediately for repair.|Defect, Breakdown|Function
Warranties|Misuse|/ˌmɪsˈjuːs/|Sử dụng sai cách, không đúng hướng dẫn|Warranty is void if product is misused.|Abuse, Improper use|Proper use
Warranties|Promise|/ˈprɒmɪs/|Lời hứa, cam kết của nhà sản xuất|The company promises quality workmanship.|Pledge, Commitment|Denial
Warranties|Protect|/prəˈtekt/|Bảo vệ khách hàng khỏi chi phí sửa chữa|The warranty protects against defects.|Guard, Shield|Expose
Warranties|Replacement|/rɪˈpleɪsmənt/|Thay thế sản phẩm lỗi bằng sản phẩm mới|Receive a replacement within 5 business days.|Substitute, Exchange|Original
Warranties|Reputation|/ˌrepjuˈteɪʃn/|Danh tiếng công ty về dịch vụ bảo hành|Maintain reputation through excellent service.|Standing, Image|Infamy
Warranties|Require|/rɪˈkwaɪər/|Yêu cầu, đòi hỏi điều kiện để bảo hành|Warranty requires proof of purchase.|Need, Demand|Optional
Warranties|Restore|/rɪˈstɔːr/|Khôi phục sản phẩm về tình trạng ban đầu|Restore the item to working condition.|Repair, Reinstate|Damage
Warranties|Terms and conditions|/tɜːrmz ənd kənˈdɪʃnz/|Điều khoản và điều kiện của bảo hành|Read the terms and conditions thoroughly.|Rules, Provisions|N/A
Warranties|Transferable|/trænsˈfɜːrəbl/|Có thể chuyển nhượng bảo hành cho người khác|The warranty is transferable to new owners.|Assignable, Movable|Non-transferable
Warranties|Variety|/vəˈraɪəti/|Sự đa dạng các loại bảo hành có sẵn|Offer a variety of warranty options.|Diversity, Range|Uniformity
Warranties|Void|/vɔɪd/|Vô hiệu, không còn giá trị pháp lý|Tampering voids the warranty.|Invalid, Null|Valid
        `;

        const parseData = (str) => {
            return str.trim().split('\n').filter(line => line.trim() !== '').map((line, index) => {
                const parts = line.split('|');
                return {
                    id: index + 1,
                    topic: parts[0],
                    word: parts[1],
                    ipa: parts[2],
                    meaning: parts[3],
                    example: parts[4],
                    synonym: parts[5] || "N/A",
                    antonym: parts[6] || "N/A",
                    family: parts[7] || "N/A"
                };
            });
        };

        const toeicData = parseData(rawDataString);

        // --- SOUND HELPER ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'flip') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.05); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(now); osc.stop(now + 0.05);
            } else if (type === 'match') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'miss') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2);
            }
        };

        // --- COMPONENTS ---
        const SpeakerButton = ({ text, lang = 'US', className = "" }) => {
            const speak = (e) => {
                e.stopPropagation();
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    const voices = window.speechSynthesis.getVoices();
                    let voice = null;
                    if (lang === 'US') voice = voices.find(v => v.lang === 'en-US' && !v.name.includes('UK'));
                    else voice = voices.find(v => v.lang === 'en-GB' || v.name.includes('UK'));
                    if (voice) utterance.voice = voice; else utterance.lang = lang === 'US' ? 'en-US' : 'en-GB';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            };
            return ( <button onClick={speak} className={`inline-flex items-center justify-center gap-1 px-2 py-1 rounded text-[10px] font-bold transition-all border ${className} ${lang === 'US' ? 'bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100' : 'bg-red-50 text-red-700 border-red-200 hover:bg-red-100'}`} title={lang === 'US' ? 'Giọng Mỹ (US)' : 'Giọng Anh (UK)'}> <i className="fas fa-volume-up"></i> {lang} </button> );
        };

        const LinkedWordList = ({ text, jumpToWord, colorClass = "text-gray-600" }) => {
            if (!text || text === "N/A") return <span className="text-gray-400 italic text-xs">Không có</span>;
            const words = text.split(',').map(w => w.trim());
            return ( 
                <span> 
                    {words.map((w, i) => { 
                        const exists = toeicData.some(item => item.word.toLowerCase() === w.toLowerCase()); 
                        return ( 
                            <React.Fragment key={i}> 
                                {i > 0 && ", "} 
                                {exists ? ( 
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); jumpToWord(w); }} 
                                        className={`${colorClass} hover:underline font-bold cursor-pointer hover:bg-yellow-100 px-1 rounded transition-all`}
                                        title="Xem chi tiết từ này"
                                    >
                                        {w}
                                    </button> 
                                ) : ( 
                                    <span className={colorClass}>{w}</span> 
                                )} 
                            </React.Fragment> 
                        ); 
                    })} 
                </span> 
            );
        };

        const WordItem = ({ item, isLearned, isDetailOpen, isHighlighted, toggleLearned, toggleDetails, jumpToWord }) => (
            <div id={`word-${item.id}`} className={`p-4 rounded-lg border transition-all ${isHighlighted ? 'ring-4 ring-yellow-400 bg-yellow-50 scale-105 z-10 shadow-xl' : 'bg-white border-slate-200'} ${isLearned ? 'bg-emerald-50' : ''}`}>
                <div className="flex justify-between">
                    <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1"> <span className="text-[10px] font-bold uppercase text-slate-500 bg-slate-100 px-1 rounded">{item.topic}</span> </div>
                        <div className="flex items-center gap-2 flex-wrap"> <h3 className="text-lg font-bold text-slate-800">{item.word}</h3> <div className="flex gap-1"> <SpeakerButton text={item.word} lang="US" /> <SpeakerButton text={item.word} lang="UK" /> </div> </div>
                        <p className="text-xs text-slate-500 font-mono mt-1">{item.ipa}</p>
                    </div>
                    <button onClick={() => toggleLearned(item.id)} className={`w-8 h-8 rounded-full flex items-center justify-center border ${isLearned ? 'bg-emerald-500 text-white' : 'text-gray-300'}`}><i className="fas fa-check"></i></button>
                </div>
                <div className="mt-2 pt-2 border-t border-slate-100">
                    <p className="font-medium text-sm text-slate-800">{item.meaning}</p>
                    <button onClick={() => toggleDetails(item.id)} className="text-xs text-indigo-500 font-semibold mt-1 hover:text-indigo-700 flex items-center gap-1"> 
                        {isDetailOpen ? 'Thu gọn' : 'Chi tiết'} <i className={`fas fa-chevron-${isDetailOpen ? 'up' : 'down'}`}></i> 
                    </button>
                    
                    {isDetailOpen && ( 
                        <div className="mt-2 text-sm space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100 animate-fadeIn"> 
                            <div><span className="font-bold text-slate-700 text-xs uppercase block mb-1">Ví dụ:</span> <p className="italic text-slate-600 bg-white p-2 rounded border border-slate-200">"{item.example}"</p></div>
                            
                            <div className="grid grid-cols-1 gap-2 border-t border-slate-200 pt-2 mt-2">
                                <div className="flex flex-col">
                                    <span className="font-bold text-blue-600 text-xs uppercase mb-1">Đồng nghĩa:</span>
                                    <div className="bg-blue-50 p-2 rounded border border-blue-100 text-sm">
                                        <LinkedWordList text={item.synonym} jumpToWord={jumpToWord} colorClass="text-blue-800" />
                                    </div>
                                </div>
                                <div className="flex flex-col">
                                    <span className="font-bold text-red-500 text-xs uppercase mb-1">Trái nghĩa:</span>
                                    <div className="bg-red-50 p-2 rounded border border-red-100 text-sm">
                                        <LinkedWordList text={item.antonym} jumpToWord={jumpToWord} colorClass="text-red-800" />
                                    </div>
                                </div>
                                <div className="flex flex-col">
                                    <span className="font-bold text-purple-600 text-xs uppercase mb-1">Gia đình từ:</span>
                                    <div className="bg-purple-50 p-2 rounded border border-purple-100 text-sm">
                                        <LinkedWordList text={item.family} jumpToWord={jumpToWord} colorClass="text-purple-800" />
                                    </div>
                                </div>
                            </div>
                        </div> 
                    )}
                </div>
            </div>
        );

        const WordListView = ({ data, learnedWords, toggleLearned, showDetails, toggleDetails, highlightedId, jumpToWord }) => ( 
            <div className="grid gap-3 md:grid-cols-2 lg:grid-cols-3"> 
                {data.map(item => ( 
                    <WordItem 
                        key={item.id} 
                        item={item} 
                        isLearned={learnedWords.has(item.id)} 
                        isDetailOpen={showDetails === item.id} 
                        isHighlighted={highlightedId === item.id} 
                        toggleLearned={toggleLearned} 
                        toggleDetails={toggleDetails}
                        jumpToWord={jumpToWord}
                    /> 
                ))} 
            </div> 
        );

        const FlashcardView = ({ data, learnedWords, toggleLearned }) => {
            const [index, setIndex] = React.useState(0);
            const [isFlipped, setIsFlipped] = React.useState(false);
            React.useEffect(() => { setIndex(0); setIsFlipped(false); }, [data.length]);
            const next = () => { setIsFlipped(false); setTimeout(() => setIndex(prev => (prev + 1) % data.length), 150); };
            const prev = () => { setIsFlipped(false); setTimeout(() => setIndex(prev => (prev - 1 + data.length) % data.length), 150); };
            if (data.length === 0) return <div className="text-center p-10 text-gray-400">Không có dữ liệu</div>;
            const item = data[index];
            const isLearned = learnedWords.has(item.id);
            return (
                <div className="flex flex-col items-center h-full justify-center py-4">
                    <div className="perspective-1000 w-full max-w-sm h-80 cursor-pointer group" onClick={() => setIsFlipped(!isFlipped)}>
                        <div className={`relative w-full h-full text-center transition-transform duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : 'rotate-y-0'}`}>
                            <div className="card-face bg-white border-2 border-slate-200 hover:border-indigo-300 transition-colors">
                                <span className="absolute top-4 left-4 bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded">{index + 1}/{data.length}</span>
                                <span className="absolute top-4 right-4 text-[10px] text-indigo-500 font-bold uppercase tracking-widest">{item.topic}</span>
                                <h2 className="text-4xl font-black text-slate-800 mb-2">{item.word}</h2>
                                <span className="text-lg text-slate-500 font-mono mb-4 bg-slate-50 px-2 rounded">{item.ipa}</span>
                                <div className="text-xs text-slate-400 animate-pulse mt-4 flex items-center gap-1"><i className="fas fa-sync-alt"></i> Chạm để lật</div>
                                <div className="flex gap-2 mt-4" onClick={(e) => e.stopPropagation()}> <SpeakerButton text={item.word} lang="US" /> <SpeakerButton text={item.word} lang="UK" /> </div>
                            </div>
                            <div className="card-face rotate-y-180 bg-slate-800 text-white">
                                <h3 className="text-2xl font-bold mb-2 text-yellow-400 px-4">{item.meaning}</h3>
                                <p className="text-sm italic opacity-90 mb-4 px-6 text-slate-300">"{item.example}"</p>
                                <div className="flex gap-4 absolute bottom-6"> <button onClick={(e) => { e.stopPropagation(); toggleLearned(item.id); }} className={`w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm transition ${isLearned ? 'bg-green-500 text-white shadow-lg shadow-green-500/50' : 'bg-white/10 hover:bg-white/30'}`}><i className="fas fa-check"></i></button> </div>
                            </div>
                        </div>
                    </div>
                    <div className="flex items-center gap-6 mt-6"> <button onClick={prev} className="px-5 py-2 bg-white shadow-md rounded-full hover:bg-indigo-50 text-indigo-900 transition"><i className="fas fa-arrow-left"></i></button> <button onClick={next} className="px-5 py-2 bg-white shadow-md rounded-full hover:bg-indigo-50 text-indigo-900 transition"><i className="fas fa-arrow-right"></i></button> </div>
                </div>
            );
        };

        const QuizView = ({ allData, setCoins, user, speakWord }) => {
            const [currentQuestion, setCurrentQuestion] = React.useState(null);
            const [options, setOptions] = React.useState([]);
            const [selectedOption, setSelectedOption] = React.useState(null);
            const [isCorrect, setIsCorrect] = React.useState(null);
            const [streak, setStreak] = React.useState(0);
            const [bonus, setBonus] = React.useState(null);

            const generateQuestion = () => {
                const randomItem = allData[Math.floor(Math.random() * allData.length)];
                const distractors = [];
                while (distractors.length < 3) {
                    const d = allData[Math.floor(Math.random() * allData.length)];
                    if (d.id !== randomItem.id && !distractors.find(x => x.id === d.id)) {
                        distractors.push(d);
                    }
                }
                const allOptions = [...distractors, randomItem].sort(() => Math.random() - 0.5);
                setCurrentQuestion(randomItem);
                setOptions(allOptions);
                setSelectedOption(null);
                setIsCorrect(null);
                setBonus(null);
                speakWord(randomItem.word);
            };

            React.useEffect(() => { generateQuestion(); }, []);

            const handleAnswer = (option) => {
                if (selectedOption) return;
                setSelectedOption(option);
                const correct = option.id === currentQuestion.id;
                setIsCorrect(correct);
                if (correct) {
                    playSound('match');
                    let earned = 20;
                    let streakBonus = 0;
                    if (streak >= 2) streakBonus = 5;
                    if (streak >= 5) streakBonus = 10;
                    if (streak >= 10) streakBonus = 20;
                    const totalEarned = earned + streakBonus;
                    setBonus(totalEarned);
                    setCoins(prev => prev + totalEarned);
                    setStreak(s => s + 1);
                    if (user && db) {
                        const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').doc(user.uid);
                        const currentCoins = parseInt(localStorage.getItem('toeic_user_coins') || 0) + totalEarned;
                        userRef.set({ coins: currentCoins }, { merge: true });
                    }
                    setTimeout(generateQuestion, 1000);
                } else {
                    playSound('miss');
                    setStreak(0);
                    setTimeout(generateQuestion, 1500);
                }
            };

            if (!currentQuestion) return <div className="p-10 text-center">Đang tải câu hỏi...</div>;

            return (
                <div className="max-w-xl mx-auto py-6 px-4">
                    <div className="flex justify-between items-center mb-6">
                        <div className="text-orange-500 font-bold text-xl flex items-center gap-2"><i className="fas fa-fire"></i> {streak > 0 ? `Streak x${streak}` : 'Quiz Mode'}</div>
                        {bonus && (<div className="coin-float text-yellow-500 font-black text-2xl absolute right-10">+{bonus} <i className="fas fa-coins"></i></div>)}
                    </div>
                    <div className="bg-white p-8 rounded-2xl shadow-lg text-center mb-6 border-b-4 border-indigo-100">
                        <span className="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-2 block">{currentQuestion.topic}</span>
                        <h2 className="text-4xl font-black text-slate-800 mb-2">{currentQuestion.word}</h2>
                        <div className="flex justify-center gap-2 mb-4">
                            <span className="text-slate-400 font-mono">{currentQuestion.ipa}</span>
                            <button onClick={() => speakWord(currentQuestion.word)} className="text-indigo-500 hover:text-indigo-700"><i className="fas fa-volume-up"></i></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 gap-3">
                        {options.map((opt, idx) => {
                            let btnClass = "bg-white border-2 border-slate-200 text-slate-700 hover:border-indigo-300 hover:bg-indigo-50";
                            if (selectedOption) {
                                if (opt.id === currentQuestion.id) btnClass = "bg-green-100 border-green-500 text-green-800 font-bold";
                                else if (opt.id === selectedOption.id) btnClass = "bg-red-100 border-red-500 text-red-800 animate-shake";
                                else btnClass = "bg-slate-50 border-slate-100 text-slate-400 opacity-50";
                            }
                            return (
                                <button key={idx} onClick={() => handleAnswer(opt)} className={`p-4 rounded-xl text-left transition-all text-sm font-medium ${btnClass}`} disabled={!!selectedOption}>
                                    <span className="inline-block w-6 font-bold opacity-50">{['A', 'B', 'C', 'D'][idx]}.</span>
                                    {opt.meaning}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const LeaderboardModal = ({ isOpen, onClose, user, coins }) => {
            const [leaders, setLeaders] = React.useState([]);
            const [name, setName] = React.useState('');
            const [isSaving, setIsSaving] = React.useState(false);
            React.useEffect(() => {
                if (isOpen) {
                    if (!db) return;
                    fetchLeaders();
                    if (user && !user.isAnonymous) {
                        const loadProfile = async () => {
                            const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').doc(user.uid);
                            try { const snap = await userRef.get(); if (snap.exists) setName(snap.data().displayName || user.displayName || ''); } catch (e) { console.error(e); }
                        };
                        loadProfile();
                    } else if (user) {
                         const loadProfile = async () => {
                            const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').doc(user.uid);
                            try { const snap = await userRef.get(); if (snap.exists) setName(snap.data().displayName || ''); } catch (e) { console.error(e); }
                        };
                        loadProfile();
                    }
                }
            }, [isOpen, user]);
            const fetchLeaders = async () => {
                if (!db) return;
                const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard');
                colRef.onSnapshot((snapshot) => { const data = []; snapshot.forEach(doc => data.push(doc.data())); data.sort((a, b) => b.coins - a.coins); setLeaders(data.slice(0, 10)); });
            };
            const saveProfile = async () => {
                if (!name.trim() || !user || !db) return;
                setIsSaving(true);
                try {
                    const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').doc(user.uid);
                    await userRef.set({ userId: user.uid, displayName: name, coins: coins, updatedAt: new Date().toISOString() }, { merge: true });
                    alert("Đã lưu tên thành công!");
                } catch (e) { alert("Lỗi lưu tên."); } finally { setIsSaving(false); }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-5 bg-gradient-to-r from-yellow-400 to-orange-500 text-white flex justify-between items-center"> <h2 className="text-xl font-black flex items-center gap-2"><i className="fas fa-trophy"></i> Bảng Xếp Hạng</h2> <button onClick={onClose} className="hover:bg-white/20 p-2 rounded-full transition"><i className="fas fa-times"></i></button> </div>
                        <div className="p-5 overflow-y-auto flex-1">
                            {!db && <div className="p-3 mb-4 bg-red-100 text-red-700 text-xs rounded border border-red-200">Bạn chưa cấu hình Firebase.</div>}
                            <div className="bg-indigo-50 p-4 rounded-xl mb-6 border border-indigo-100">
                                <h3 className="font-bold text-indigo-900 mb-2 text-sm uppercase">Hồ sơ của bạn</h3>
                                <div className="flex gap-2"> <input type="text" className="flex-1 border rounded px-3 py-2 text-sm" placeholder="Tên hiển thị..." value={name} onChange={(e) => setName(e.target.value)} disabled={!db} /> <button onClick={saveProfile} disabled={isSaving || !db} className="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700 disabled:opacity-50">{isSaving ? '...' : 'Lưu'}</button> </div>
                            </div>
                            <div className="space-y-3"> {leaders.map((leader, index) => ( <div key={index} className={`flex items-center justify-between p-3 rounded-lg border ${leader.userId === user?.uid ? 'bg-yellow-50 border-yellow-300' : 'bg-white border-slate-100'}`}> <div className="flex items-center gap-3"> <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${index === 0 ? 'bg-yellow-400 text-white' : index === 1 ? 'bg-gray-300 text-white' : index === 2 ? 'bg-amber-600 text-white' : 'bg-slate-100 text-slate-500'}`}>{index + 1}</div> <div><div className="font-bold text-slate-800 text-sm">{leader.displayName || 'Ẩn danh'}</div>{leader.userId === user?.uid && <span className="text-[10px] text-indigo-500 font-bold bg-indigo-100 px-1.5 rounded">Bạn</span>}</div> </div> <div className="font-black text-indigo-600 flex items-center gap-1">{leader.coins.toLocaleString()} <i className="fas fa-coins text-yellow-500 text-xs"></i></div> </div> ))} {leaders.length === 0 && <p className="text-center text-gray-400 text-sm">{db ? "Chưa có dữ liệu." : "Vui lòng kết nối Firebase."}</p>} </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MemoryGameView = ({ allData, setCoins, user, coins }) => {
            const [gameMode, setGameMode] = React.useState(null); 
            const [cards, setCards] = React.useState([]);
            const [flippedIndices, setFlippedIndices] = React.useState([]);
            const [matchedIndices, setMatchedIndices] = React.useState([]);
            const [level, setLevel] = React.useState(1);
            const [levelComplete, setLevelComplete] = React.useState(false);
            const [processing, setProcessing] = React.useState(false);
            const [matchedItem, setMatchedItem] = React.useState(null);
            const [currentPlayer, setCurrentPlayer] = React.useState(1);
            const [scores, setScores] = React.useState({ 1: 0, 2: 0 });
            const [pvpWinner, setPvPWinner] = React.useState(null);
            const [aiMemory, setAiMemory] = React.useState({});
            const [aiTargets, setAiTargets] = React.useState([]);
            
            const [selectedTopics, setSelectedTopics] = React.useState([]);
            const uniqueTopics = React.useMemo(() => [...new Set(allData.map(i => i.topic))], [allData]);

            const [roomId, setRoomId] = React.useState('');
            const [isHost, setIsHost] = React.useState(false);
            const [onlineStatus, setOnlineStatus] = React.useState('idle'); 
            const [inputRoomId, setInputRoomId] = React.useState('');
            const [hasPaid, setHasPaid] = React.useState(false); 

            // Functions Definitions (Moved outside effects)
            const speak = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    window.speechSynthesis.speak(u);
                }
            };

            const toggleTopic = (topic) => {
                setSelectedTopics(prev => {
                    if (prev.includes(topic)) return prev.filter(t => t !== topic);
                    return [...prev, topic];
                });
            };

            const toggleAllTopics = () => {
                if (selectedTopics.length === uniqueTopics.length) setSelectedTopics([]);
                else setSelectedTopics(uniqueTopics);
            };

            const calculateAiMoves = () => {
                const memoryIndices = Object.keys(aiMemory).map(Number).filter(idx => !matchedIndices.includes(idx));
                let firstIdx = -1; let secondIdx = -1;
                for (let i = 0; i < memoryIndices.length; i++) { for (let j = i + 1; j < memoryIndices.length; j++) { const idxA = memoryIndices[i]; const idxB = memoryIndices[j]; if (cards[idxA].itemId === cards[idxB].itemId) { firstIdx = idxA; secondIdx = idxB; break; } } if (firstIdx !== -1) break; }
                if (firstIdx === -1) {
                    const unknownIndices = cards.map((_, i) => i).filter(i => !matchedIndices.includes(i) && !memoryIndices.includes(i));
                    const allAvailable = cards.map((_, i) => i).filter(i => !matchedIndices.includes(i));
                    if (unknownIndices.length > 0) firstIdx = unknownIndices[Math.floor(Math.random() * unknownIndices.length)]; else firstIdx = allAvailable[Math.floor(Math.random() * allAvailable.length)];
                    const firstCard = cards[firstIdx];
                    const matchInMemory = memoryIndices.find(idx => cards[idx].itemId === firstCard.itemId && idx !== firstIdx);
                    if (matchInMemory !== undefined) secondIdx = matchInMemory; else { const remaining = allAvailable.filter(i => i !== firstIdx); secondIdx = remaining[Math.floor(Math.random() * remaining.length)]; }
                }
                return [firstIdx, secondIdx];
            };

            const checkForMatch = ([idx1, idx2]) => {
                const card1 = cards[idx1];
                const card2 = cards[idx2];
                const isMatch = card1.itemId === card2.itemId;
                if (isMatch) {
                    setTimeout(() => {
                        playSound('match');
                        const wordToSpeak = card1.type === 'word' ? card1.content : card2.content;
                        speak(wordToSpeak);
                        const newMatched = [...matchedIndices, idx1, idx2];
                        setMatchedIndices(newMatched);
                        setFlippedIndices([]);
                        setProcessing(false);
                        
                        const matchedId = card1.itemId;
                        const itemDetails = allData.find(i => i.id === matchedId);
                        setMatchedItem(itemDetails);

                        if (gameMode === 'solo') {
                            setCoins(prev => prev + 100);
                            if (user && db) {
                                const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').doc(user.uid);
                                const currentCoins = parseInt(localStorage.getItem('toeic_user_coins') || 0) + 100;
                                userRef.set({ coins: currentCoins }, { merge: true });
                            }
                        } else { setScores(prev => ({ ...prev, [currentPlayer]: prev[currentPlayer] + 100 })); }
                        
                        if (newMatched.length === cards.length) {
                            if (gameMode === 'solo') { setTimeout(() => setLevelComplete(true), 500); } 
                            else { setTimeout(() => { const winner = scores[1] > scores[2] ? 1 : (scores[2] > scores[1] ? 2 : 'draw'); setPvPWinner(winner); }, 500); }
                        }
                    }, 600);
                } else {
                    setTimeout(() => {
                        playSound('miss');
                        setFlippedIndices([]);
                        setProcessing(false);
                        if (gameMode === 'ai') { setCurrentPlayer(prev => prev === 1 ? 2 : 1); }
                    }, 1000);
                }
            };

            const handleOnlineCardClick = async (index) => {
                const amIHost = isHost;
                if (processing) return; 
                const isMyTurn = (amIHost && currentPlayer === 1) || (!amIHost && currentPlayer === 2);
                if (!isMyTurn) return; 
                if (flippedIndices.includes(index) || matchedIndices.includes(index)) return;
                playSound('flip');
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId);
                const newFlipped = [...flippedIndices, index];
                await roomRef.update({ flipped: newFlipped });
                if (newFlipped.length === 2) {
                    await roomRef.update({ processing: true });
                    const card1 = cards[newFlipped[0]];
                    const card2 = cards[newFlipped[1]];
                    const isMatch = card1.itemId === card2.itemId;
                    if (isMatch) {
                        setTimeout(async () => {
                            playSound('match');
                            const wordToSpeak = card1.type === 'word' ? card1.content : card2.content;
                            speak(wordToSpeak);
                            
                            const matchedId = card1.itemId;
                            const itemDetails = allData.find(i => i.id === matchedId);
                            setMatchedItem(itemDetails);

                            const newMatched = [...matchedIndices, ...newFlipped];
                            const newScores = { ...scores };
                            if (amIHost) newScores.host += 100; else newScores.guest += 100;
                            await roomRef.update({ matched: newMatched, flipped: [], scores: newScores, processing: false });
                        }, 600);
                    } else {
                        setTimeout(async () => {
                            playSound('miss');
                            const doc = await roomRef.get();
                            const currentData = doc.data();
                            const nextTurn = currentData.turn === currentData.hostId ? currentData.guestId : currentData.hostId;
                            await roomRef.update({ flipped: [], processing: false, turn: nextTurn });
                        }, 1000);
                    }
                }
            };

            const handleCardClick = (index) => {
                if (gameMode === 'pvp_online') { handleOnlineCardClick(index); return; }
                if (processing || flippedIndices.includes(index) || matchedIndices.includes(index)) return;
                playSound('flip');
                const newFlipped = [...flippedIndices, index];
                setFlippedIndices(newFlipped);
                setAiMemory(prev => ({ ...prev, [index]: cards[index].itemId }));
                if (newFlipped.length === 2) { setProcessing(true); checkForMatch(newFlipped); }
            };

            const performAiTurn = () => {
                if (aiTargets.length === 0) {
                    const moves = calculateAiMoves();
                    setAiTargets(moves);
                }
            };

            const startLevel = (mode = gameMode) => {
                setLevelComplete(false); setMatchedIndices([]); setFlippedIndices([]); setPvPWinner(null); setAiMemory({}); setHasPaid(false); setAiTargets([]);
                if (level === 1) { setCurrentPlayer(1); setScores({ 1: 0, 2: 0 }); }
                
                let availableData = allData;
                if (selectedTopics.length > 0) {
                    availableData = allData.filter(item => selectedTopics.includes(item.topic));
                }
                if (availableData.length < 8) availableData = allData;

                const shuffledData = [...availableData].sort(() => Math.random() - 0.5);
                const pairCount = (mode === 'ai' || mode === 'pvp_online') ? 8 : 6;
                const selectedItems = shuffledData.slice(0, pairCount);
                
                let cardSet = [];
                selectedItems.forEach(item => { cardSet.push({ id: `word-${item.id}-${Math.random()}`, content: item.word, type: 'word', itemId: item.id }); cardSet.push({ id: `mean-${item.id}-${Math.random()}`, content: item.meaning, type: 'meaning', itemId: item.id }); });
                setCards(cardSet.sort(() => Math.random() - 0.5));
            };

            const startGameWithTopics = (mode) => {
                setGameMode(mode);
                startLevel(mode);
            };

            const createRoom = async () => {
                if (!user || !db) return alert("Vui lòng đăng nhập!");
                if (coins < 200) return alert("Bạn cần ít nhất 200 xu để cược!");
                try {
                    const newRoomId = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    let availableData = allData;
                    if (selectedTopics.length > 0) availableData = allData.filter(item => selectedTopics.includes(item.topic));
                    if (availableData.length < 8) availableData = allData;

                    const shuffledData = [...availableData].sort(() => Math.random() - 0.5);
                    const selectedItems = shuffledData.slice(0, 8); 
                    let cardSet = [];
                    selectedItems.forEach(item => { cardSet.push({ id: `word-${item.id}-${Math.random()}`, content: item.word, type: 'word', itemId: item.id }); cardSet.push({ id: `mean-${item.id}-${Math.random()}`, content: item.meaning, type: 'meaning', itemId: item.id }); });
                    cardSet.sort(() => Math.random() - 0.5);
                    
                    const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(newRoomId);
                    await roomRef.set({ hostId: user.uid, guestId: null, status: 'waiting', board: cardSet, flipped: [], matched: [], turn: user.uid, scores: { host: 0, guest: 0 }, processing: false, createdAt: new Date().toISOString() });
                    setRoomId(newRoomId); setIsHost(true); setOnlineStatus('waiting'); setHasPaid(false);
                } catch (error) { console.error("Lỗi tạo phòng:", error); alert("Lỗi tạo phòng. Hãy kiểm tra mạng."); }
            };

            const joinRoom = async () => {
                 if (!user || !db) return alert("Vui lòng đăng nhập!");
                if (coins < 200) return alert("Bạn cần ít nhất 200 xu để cược!");
                if (!inputRoomId) return alert("Vui lòng nhập mã phòng!");
                try {
                    const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(inputRoomId);
                    const doc = await roomRef.get();
                    if (!doc.exists) return alert("Phòng không tồn tại!");
                    if (doc.data().hostId === user.uid) return alert("Bạn không thể tự vào phòng của chính mình!");
                    if (doc.data().status !== 'waiting') return alert("Phòng đang chơi hoặc đã đầy!");
                    await roomRef.update({ guestId: user.uid, status: 'playing' });
                    setRoomId(inputRoomId); setIsHost(false); setOnlineStatus('playing'); setHasPaid(false);
                } catch (error) { console.error("Lỗi vào phòng:", error); alert("Lỗi kết nối phòng."); }
            };
            
            // --- EFFECTS ---

            // AI Logic Hook 1
            React.useEffect(() => {
                 if (gameMode === 'ai' && currentPlayer === 2 && !levelComplete && !pvpWinner && !processing && flippedIndices.length === 0 && aiTargets.length === 0) {
                    const timer = setTimeout(() => performAiTurn(), 1000);
                    return () => clearTimeout(timer);
                 }
            }, [currentPlayer, gameMode, processing, levelComplete, pvpWinner, flippedIndices.length, aiTargets.length]);

            // AI Logic Hook 2
            React.useEffect(() => {
                if (gameMode !== 'ai' || currentPlayer !== 2 || aiTargets.length === 0) return;
                if (flippedIndices.length === 0) {
                    const timer = setTimeout(() => handleCardClick(aiTargets[0]), 400);
                    return () => clearTimeout(timer);
                } else if (flippedIndices.length === 1) {
                    if (flippedIndices[0] !== aiTargets[1]) {
                        const timer = setTimeout(() => {
                            handleCardClick(aiTargets[1]);
                            setAiTargets([]);
                        }, 800);
                        return () => clearTimeout(timer);
                    }
                }
            }, [aiTargets, flippedIndices, gameMode, currentPlayer]);

            React.useEffect(() => { if (gameMode && gameMode !== 'pvp_online') startLevel(); }, [level]); // Removed gameMode dep to avoid double reset

            // Online Sync
            React.useEffect(() => {
                if (gameMode === 'pvp_online' && roomId && db) {
                    const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId);
                    const unsubscribe = roomRef.onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            if (isHost && onlineStatus === 'waiting' && data.guestId) setOnlineStatus('playing');
                            if (data.status === 'playing') {
                                setCards(data.board || []); setFlippedIndices(data.flipped || []); setMatchedIndices(data.matched || []); setScores(data.scores || { host: 0, guest: 0 });
                                setCurrentPlayer(data.turn === data.hostId ? 1 : 2); setProcessing(data.processing || false);
                                
                                if ((data.matched || []).length === (data.board || []).length && (data.board || []).length > 0 && !hasPaid) {
                                    const s = data.scores;
                                    const winner = s.host > s.guest ? 1 : (s.guest > s.host ? 2 : 'draw');
                                    setPvPWinner(winner);
                                    setHasPaid(true); 

                                    let betAmount = 200;
                                    let newCoinBalance = coins;
                                    
                                    if (winner !== 'draw') {
                                        const amIHost = isHost;
                                        const iWon = (amIHost && winner === 1) || (!amIHost && winner === 2);
                                        if (iWon) newCoinBalance += betAmount; else newCoinBalance -= betAmount;
                                        setCoins(newCoinBalance);
                                        if (user && db) {
                                            const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').doc(user.uid);
                                            userRef.set({ coins: newCoinBalance }, { merge: true });
                                        }
                                    }
                                }
                            }
                        }
                    });
                    return () => unsubscribe();
                }
            }, [gameMode, roomId, isHost, onlineStatus, hasPaid, coins]);


            // TOPIC SELECTION SCREEN
            if (!gameMode) {
                return (
                    <div className="flex flex-col items-center p-4 animate-fadeIn">
                        <h2 className="text-2xl font-black text-indigo-900 mb-2">Cài Đặt Trò Chơi</h2>
                        <div className="bg-white p-4 rounded-xl shadow-md w-full max-w-2xl border border-indigo-50 mb-6">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-gray-700">Chọn Chủ Đề ({selectedTopics.length || 'Tất cả'})</h3>
                                <button 
                                    onClick={toggleAllTopics}
                                    className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100"
                                >
                                    {selectedTopics.length === uniqueTopics.length ? 'Bỏ chọn hết' : 'Chọn tất cả'}
                                </button>
                            </div>
                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto pr-1">
                                {uniqueTopics.map(topic => (
                                    <button
                                        key={topic}
                                        onClick={() => toggleTopic(topic)}
                                        className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all topic-chip ${selectedTopics.includes(topic) ? 'selected' : 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100'}`}
                                    >
                                        {topic}
                                    </button>
                                ))}
                            </div>
                            <div className="mt-2 text-xs text-gray-400 italic text-center">
                                {selectedTopics.length === 0 ? "Chế độ: Tự động Mix (Tất cả chủ đề)" : "Chế độ: Mix Thủ công"}
                            </div>
                        </div>

                        <div className="flex flex-col gap-4 w-full max-w-sm">
                            <button onClick={() => startGameWithTopics('solo')} className="p-4 bg-white border-2 border-indigo-100 hover:border-indigo-500 rounded-xl shadow-sm hover:shadow-md transition flex items-center gap-4 group">
                                <div className="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center group-hover:bg-indigo-100"><i className="fas fa-user text-xl text-indigo-600"></i></div>
                                <div className="text-left"><span className="font-bold block text-slate-800">Luyện tập (1 người)</span><span className="text-xs text-slate-400">Kiếm xu, qua màn</span></div>
                            </button>
                            <button onClick={() => startGameWithTopics('ai')} className="p-4 bg-white border-2 border-purple-100 hover:border-purple-500 rounded-xl shadow-sm hover:shadow-md transition flex items-center gap-4 group">
                                <div className="w-12 h-12 bg-purple-50 rounded-full flex items-center justify-center group-hover:bg-purple-100"><i className="fas fa-robot text-xl text-purple-600"></i></div>
                                <div className="text-left"><span className="font-bold block text-slate-800">Đấu với Máy (AI)</span><span className="text-xs text-slate-400">Luyện phản xạ</span></div>
                            </button>
                            <button onClick={() => startGameWithTopics('pvp_online')} className="p-4 bg-white border-2 border-orange-100 hover:border-orange-500 rounded-xl shadow-sm hover:shadow-md transition flex items-center gap-4 group">
                                <div className="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center group-hover:bg-orange-100"><i className="fas fa-globe text-xl text-orange-600"></i></div>
                                <div className="text-left"><span className="font-bold block text-slate-800">Online PvP (Cược 200)</span><span className="text-xs text-slate-400">Đấu với người thật</span></div>
                            </button>
                        </div>
                    </div>
                );
            }

            // ONLINE WAITING SCREEN
            if (gameMode === 'pvp_online' && onlineStatus !== 'playing') {
                return (
                    <div className="flex flex-col items-center justify-center h-[500px] gap-6 animate-fadeIn">
                        <button onClick={() => { setGameMode(null); setOnlineStatus('idle'); }} className="absolute top-4 left-4 text-slate-400 hover:text-slate-600 font-bold"><i className="fas fa-arrow-left"></i> Menu</button>
                        {onlineStatus === 'waiting' ? (
                            <div className="text-center">
                                <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"> <i className="fas fa-wifi text-4xl text-orange-500"></i> </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Đang chờ đối thủ...</h3> 
                                <p className="text-slate-500 mb-4">Gửi mã này cho bạn bè:</p> 
                                <div className="text-4xl font-black text-indigo-600 bg-white border-2 border-indigo-100 px-6 py-3 rounded-xl tracking-widest shadow-sm mb-6">{roomId}</div> 
                                <p className="text-xs font-bold text-orange-600 mb-2"><i className="fas fa-coins"></i> Cược: 200 Xu</p>
                                <p className="text-xs text-slate-400">Đừng thoát màn hình này nhé.</p>
                            </div>
                        ) : (
                            <div className="space-y-4 w-full max-w-xs text-center">
                                <h2 className="text-2xl font-black text-indigo-900 mb-6">Online PvP Lobby</h2>
                                <p className="text-sm font-bold text-orange-600 bg-orange-50 py-2 rounded-lg mb-4"><i className="fas fa-coins"></i> Phí tham gia: 200 Xu</p>
                                <button onClick={createRoom} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2"> <i className="fas fa-plus-circle"></i> Tạo Phòng Mới </button>
                                <div className="relative"> <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div> <div className="relative flex justify-center text-sm"><span className="px-2 bg-[#f0f4f8] text-gray-500">Hoặc vào phòng</span></div> </div>
                                <div className="flex gap-2"> <input type="text" className="flex-1 border-2 border-gray-200 rounded-xl px-4 py-2 focus:outline-none focus:border-indigo-500 font-bold text-center tracking-widest" placeholder="Nhập mã phòng" maxLength="6" value={inputRoomId} onChange={(e) => setInputRoomId(e.target.value)} /> <button onClick={joinRoom} className="bg-white border-2 border-indigo-100 text-indigo-600 px-4 py-2 rounded-xl font-bold hover:bg-indigo-50">Vào</button> </div>
                            </div>
                        )}
                    </div>
                );
            }

            const myTurn = (gameMode === 'pvp_online') ? ((isHost && currentPlayer === 1) || (!isHost && currentPlayer === 2)) : true;

            return (
                <div className="max-w-3xl mx-auto py-4 px-2 relative">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => { setGameMode(null); setOnlineStatus('idle'); }} className="text-slate-400 hover:text-slate-600 text-sm font-bold"><i className="fas fa-arrow-left"></i> Menu</button>
                        {gameMode === 'solo' ? (
                            <div className="flex gap-4 items-center"> <div className="text-xl font-black text-indigo-800">Level {level}</div> <div className="text-sm text-slate-500">Đã ghép: <span className="font-bold text-indigo-600">{matchedIndices.length / 2}</span> / {cards.length / 2}</div> </div>
                        ) : (
                            <div className="flex gap-4 sm:gap-8 items-center bg-white px-4 sm:px-6 py-2 rounded-full shadow-sm border border-slate-100">
                                <div className={`flex flex-col items-center px-4 py-1 rounded-lg transition-all ${currentPlayer === 1 ? 'bg-blue-50 border-b-2 border-blue-500' : 'opacity-50'}`}> <span className="text-xs font-bold text-blue-800">{gameMode === 'pvp_online' && !isHost ? 'Đối thủ' : 'Bạn (P1)'}</span> <span className="text-lg font-black text-blue-600">{scores[1]}</span> </div>
                                <div className="text-slate-300 font-bold text-xs">VS</div>
                                <div className={`flex flex-col items-center px-4 py-1 rounded-lg transition-all ${currentPlayer === 2 ? 'bg-red-50 border-b-2 border-red-500' : 'opacity-50'}`}> <span className="text-xs font-bold text-red-800">{gameMode === 'ai' ? 'Máy (AI)' : (gameMode === 'pvp_online' && !isHost ? 'Bạn (P2)' : 'Đối thủ')}</span> <span className="text-lg font-black text-red-600">{scores[2]}</span> </div>
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-4 gap-2 sm:gap-4 max-w-lg mx-auto">
                        {cards.map((card, index) => {
                            const isFlipped = flippedIndices.includes(index); const isMatched = matchedIndices.includes(index);
                            if (isMatched) return <div key={card.id} className="aspect-square opacity-0 transition-opacity duration-500"></div>;
                            return (
                                <div key={card.id} onClick={() => handleCardClick(index)} className={`relative aspect-square cursor-pointer perspective-1000 group ${!myTurn && gameMode === 'pvp_online' ? 'cursor-not-allowed opacity-80' : ''}`}>
                                    <div className={`w-full h-full transition-all duration-300 transform-style-3d relative shadow-sm rounded-lg ${isFlipped ? 'rotate-y-180' : ''}`}>
                                        <div className={`absolute inset-0 backface-hidden border-2 rounded-lg flex items-center justify-center transition-colors shadow-inner ${card.type === 'word' ? 'bg-blue-50 border-blue-200' : 'bg-red-50 border-red-200'}`}> {card.type === 'word' ? ( <div className="text-center"> <i className="fas fa-flag-usa text-3xl text-blue-300 mb-1 opacity-50"></i> <span className="block text-xs font-black text-blue-400 mt-1">EN</span> </div> ) : ( <div className="text-center"> <i className="fas fa-star text-3xl text-red-300 mb-1 opacity-50"></i> <span className="block text-xs font-black text-red-400 mt-1">VN</span> </div> )} </div>
                                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-white border-2 border-indigo-500 rounded-lg flex flex-col items-center justify-center p-2 text-center shadow-lg"> <span className="text-[10px] font-bold text-indigo-400 uppercase mb-1">{card.type === 'word' ? 'EN' : 'VN'}</span> <p className={`${card.content.length > 20 ? 'text-xs' : 'text-sm'} font-bold text-slate-800`}>{card.content}</p> </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {matchedItem && (
                       <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fadeIn">
                           <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full border-2 border-indigo-100 relative text-center"> <div className="inline-block p-3 rounded-full bg-green-100 text-green-600 mb-3 text-2xl animate-bounce"><i className="fas fa-check"></i></div> <h3 className="text-2xl font-black text-indigo-900 mb-1">{matchedItem.word}</h3> <div className="flex justify-center gap-2 mb-3"><SpeakerButton text={matchedItem.word} lang="US" /><SpeakerButton text={matchedItem.word} lang="UK" /></div> <p className="text-slate-500 font-mono text-sm mb-3">{matchedItem.ipa}</p> <p className="text-lg font-bold text-yellow-600 mb-4">{matchedItem.meaning}</p> <div className="bg-slate-50 p-3 rounded-lg text-sm text-slate-600 italic mb-5 border border-slate-100">"{matchedItem.example}"</div> <button onClick={() => setMatchedItem(null)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-105">Tiếp tục</button> </div>
                       </div>
                    )}

                    {levelComplete && gameMode === 'solo' && (
                        <div className="absolute inset-0 z-10 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center rounded-xl animate-fadeIn"> <i className="fas fa-crown text-6xl text-yellow-400 mb-4 drop-shadow-md"></i> <h2 className="text-3xl font-black text-indigo-900 mb-2">Hoàn Thành!</h2> <p className="text-slate-600 mb-6">Bạn đã vượt qua Level {level}</p> <button onClick={() => setLevel(l => l + 1)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition">Màn Tiếp Theo <i className="fas fa-arrow-right ml-2"></i></button> </div>
                    )}

                    {pvpWinner && (
                        <div className="absolute inset-0 z-10 bg-white/90 backdrop-blur-md flex flex-col items-center justify-center rounded-xl animate-fadeIn p-6 text-center">
                            {pvpWinner === 'draw' ? ( <><i className="fas fa-handshake text-6xl text-gray-400 mb-4"></i><h2 className="text-3xl font-black text-slate-800 mb-2">Hòa Nhau!</h2></> ) : ( <> <i className="fas fa-trophy text-6xl text-yellow-400 mb-4 drop-shadow-lg animate-bounce"></i> <h2 className={`text-4xl font-black mb-2 ${pvpWinner === 1 ? 'text-blue-600' : 'text-red-600'}`}> {gameMode === 'pvp_online' ? (isHost && pvpWinner === 1) || (!isHost && pvpWinner === 2) ? 'Bạn Thắng!' : 'Bạn Thua Rồi!' : (pvpWinner === 1 ? 'Bạn Thắng!' : 'Máy Thắng!')} </h2> <p className="text-xl font-bold text-slate-500 mb-4">Điểm số: {scores[pvpWinner]}</p> 
                            {gameMode === 'pvp_online' && (
                                <div className={`px-4 py-2 rounded-lg font-bold text-lg mb-4 inline-block ${(isHost && pvpWinner === 1) || (!isHost && pvpWinner === 2) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {(isHost && pvpWinner === 1) || (!isHost && pvpWinner === 2) ? '+200 Xu' : '-200 Xu'}
                                </div>
                            )}
                            </> )} <button onClick={() => { setGameMode(null); setOnlineStatus('idle'); }} className="bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-full font-bold shadow-lg transition">Về Menu Chính</button>
                        </div>
                    )}
